<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Strogo Fishing</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&family=Montserrat:ital,wght@1,900&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #0b0e14; --card-bg: rgba(23, 28, 38, 0.95); --accent: #ff5500; --text: #fff; --muted: #6e7687; --green: #00ff9d; --red: #ff4757; }
        body { background: var(--bg); color: var(--text); font-family: 'Manrope', sans-serif; margin: 0; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }
        
        .fishing-line { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .fishing-line path { fill: none; stroke: var(--accent); stroke-width: 2; stroke-dasharray: 8; opacity: 0.5; }

        .main-wrapper { position: relative; z-index: 5; width: 100%; max-width: 600px; margin: 0 auto; }
        
        .image-side { position: relative; width: 100%; display: flex; justify-content: flex-start; margin-bottom: 10px; }
        .fisherman-img { width: 150px; height: auto; -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%); transform: scaleX(-1); opacity: 0.9; }

        h1 { font-family: 'Montserrat', sans-serif; font-weight: 900; font-style: italic; font-size: 32px; margin: 0 0 20px 0; text-align: right; line-height: 1; }
        h1 span { color: var(--accent); display: block; font-size: 18px; font-weight: 700; font-style: normal; margin-top: 5px; text-transform: uppercase; letter-spacing: 3px; }

        /* TABS */
        .tabs { display: flex; gap: 8px; margin-bottom: 25px; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 12px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--muted); font-weight: 800; font-size: 12px; border-radius: 8px; cursor: pointer; transition: 0.3s; text-transform: uppercase; }
        .tab-btn.active { background: rgba(255,255,255,0.1); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }

        /* INPUTS */
        .controls { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .input-group { position: relative; display: flex; align-items: center; }
        input { width: 100%; padding: 16px; padding-right: 50px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.1); background: rgba(11, 14, 20, 0.8); color: white; outline: none; backdrop-filter: blur(10px); }
        input:focus { border-color: var(--accent); }
        .add-btn { position: absolute; right: 6px; background: var(--accent); color: white; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; }

        /* CARDS */
        .fish-list { display: flex; flex-direction: column; gap: 10px; }
        .fish-card { background: var(--card-bg); padding: 15px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); }
        .fish-card.online { border-color: rgba(0, 255, 157, 0.4); background: linear-gradient(90deg, rgba(0, 255, 157, 0.05) 0%, var(--card-bg) 100%); }
        .status-badge { padding: 6px 10px; border-radius: 10px; font-size: 10px; font-weight: 800; background: rgba(255,255,255,0.05); color: var(--muted); min-width: 70px; text-align: center; }
        .fish-card.online .status-badge { background: var(--green); color: #0b0e14; }
        
        /* STATS */
        .stats-card { background: var(--card-bg); border-radius: 20px; padding: 20px; border: 1px solid rgba(255,255,255,0.05); text-align: center; margin-top: 20px; position: relative; }
        .match-result { font-family: 'Montserrat'; font-weight: 900; font-size: 28px; letter-spacing: 2px; text-transform: uppercase; }
        .win { color: var(--green); text-shadow: 0 0 20px rgba(0,255,157,0.3); }
        .lose { color: var(--red); text-shadow: 0 0 20px rgba(255,71,87,0.3); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 15px 0; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 12px; }
        .stat-val { font-size: 18px; font-weight: 800; display: block; }
        .stat-label { font-size: 10px; color: var(--muted); text-transform: uppercase; }
        
        /* ACHIEVEMENTS */
        .save-btn { width: 100%; background: linear-gradient(45deg, #FFD700, #FFAA00); color: #000; border: none; padding: 12px; border-radius: 12px; font-weight: 800; margin-top: 15px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3); }
        .ach-card { background: linear-gradient(145deg, #1a1e29, #11141a); border: 1px solid #333; padding: 15px; border-radius: 16px; margin-bottom: 10px; position: relative; overflow: hidden; }
        .ach-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #FFD700; }
        .ach-title { font-weight: 800; font-size: 15px; margin-bottom: 5px; color: #fff; }
        .ach-meta { font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; }
        .ach-res { font-weight: 800; text-transform: uppercase; }
        
        @media (min-width: 900px) {
            body { justify-content: center; align-items: center; }
            .main-wrapper { width: 100%; display: flex; flex-direction: row; gap: 40px; align-items: flex-start; }
            .image-side { width: 40%; justify-content: flex-end; }
            .fisherman-img { width: 100%; max-width: 400px; }
            .content-side { width: 60%; margin-top: 50px; }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader { width: 10px; height: 10px; border: 2px solid #555; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rot 1s infinite linear; }
        @keyframes rot { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <svg class="fishing-line"><path id="fishingLinePath" d="" /></svg>

    <div class="main-wrapper">
        <div class="image-side">
            <img src="image.png" class="fisherman-img" id="fisherImg">
        </div>

        <div class="content-side">
            <h1>STROGO<span>Рыбалка</span></h1>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('monitor')">Онлайн</button>
                <button class="tab-btn" onclick="switchTab('stats')">Матч</button>
                <button class="tab-btn" onclick="switchTab('achievements')">Достижения</button>
            </div>

            <!-- 1. ОНЛАЙН -->
            <div id="monitor-section" class="section active">
                <div class="controls">
                    <div class="input-group">
                        <input type="text" id="playerInput" placeholder="Никнейм или ссылка...">
                        <button class="add-btn" id="btn1" onclick="addNewFish()">+</button>
                    </div>
                </div>
                <div id="fishContainer" class="fish-list"></div>
            </div>

            <!-- 2. СТАТИСТИКА -->
            <div id="stats-section" class="section">
                <div class="controls">
                    <div class="input-group">
                        <input type="text" id="matchInput" placeholder="Ссылка на матч...">
                        <button class="add-btn" id="btn2" onclick="getMatchStats()">➜</button>
                    </div>
                </div>
                <div id="statsResult"></div>
            </div>

            <!-- 3. ДОСТИЖЕНИЯ -->
            <div id="achievements-section" class="section">
                <div id="achievementsList" class="fish-list"></div>
            </div>

        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); tg.headerColor = '#0b0e14'; tg.backgroundColor = '#0b0e14';

        const API_CHECK = "/api/check_fish"; 
        const API_STATS = "/api/get_match_stats";

        // Глобальные данные
        let currentMatchData = null; // Здесь храним загруженный матч
        let players = [{ name: "m0NESY", url: "https://www.faceit.com/ru/players/m0NESY" }];
        let achievements = [];

        // Загрузка
        if (localStorage.getItem('strogo_players')) players = JSON.parse(localStorage.getItem('strogo_players'));
        if (localStorage.getItem('strogo_achievements')) achievements = JSON.parse(localStorage.getItem('strogo_achievements'));

        // --- ЛЕСКА ---
        function updateLine() {
            const path = document.getElementById('fishingLinePath');
            const img = document.getElementById('fisherImg');
            const activeSec = document.querySelector('.section.active');
            let btn = activeSec.id === 'monitor-section' ? document.getElementById('btn1') : document.getElementById('btn2');
            if (activeSec.id === 'achievements-section') btn = null; // В достижениях леска не нужна особо

            if (!img || !btn) { path.setAttribute('d', ''); return; }
            
            const r1 = img.getBoundingClientRect();
            const r2 = btn.getBoundingClientRect();
            const sx = r1.left + r1.width*0.75, sy = r1.top + r1.height*0.3;
            const ex = r2.left + r2.width/2, ey = r2.top + r2.height/2;
            path.setAttribute('d', `M ${sx} ${sy} Q ${(sx+ex)/2} ${Math.max(sy,ey)+80} ${ex} ${ey}`);
        }
        setInterval(updateLine, 300);

        // --- ТАБЫ ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            if (tab === 'monitor') {
                document.querySelector('button[onclick="switchTab(\'monitor\')"]').classList.add('active');
                document.getElementById('monitor-section').classList.add('active');
            } else if (tab === 'stats') {
                document.querySelector('button[onclick="switchTab(\'stats\')"]').classList.add('active');
                document.getElementById('stats-section').classList.add('active');
            } else {
                document.querySelector('button[onclick="switchTab(\'achievements\')"]').classList.add('active');
                document.getElementById('achievements-section').classList.add('active');
                renderAchievements();
            }
            updateLine();
        }

        // --- 1. ЛОГИКА ОНЛАЙНА ---
        function renderList() {
            const c = document.getElementById('fishContainer'); c.innerHTML = '';
            players.forEach((p, i) => {
                const div = document.createElement('div'); div.className = 'fish-card';
                div.innerHTML = `<div class="fish-info"><span class="fish-name">${p.name}</span></div><div class="status-badge" id="s-${i}"><span class="loader"></span></div><div class="delete-btn" onclick="delFish(${i})">×</div>`;
                c.appendChild(div); checkStatus(p.url, i);
            });
        }
        async function checkStatus(url, i) {
            try {
                const res = await fetch(API_CHECK, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({url}) });
                const d = await res.json();
                const b = document.getElementById(`s-${i}`);
                if(d.status === 'online') { b.textContent = 'В ПРУДУ'; b.closest('.fish-card').classList.add('online'); }
                else b.textContent = 'OFF';
            } catch(e) {}
        }
        function addNewFish() {
            const v = document.getElementById('playerInput').value.trim();
            if(!v) return;
            let name = v.includes('faceit.com') ? v.split('/').pop() : v;
            let url = v.includes('faceit.com') ? v : `https://www.faceit.com/ru/players/${v}`;
            players.unshift({name, url}); localStorage.setItem('strogo_players', JSON.stringify(players));
            document.getElementById('playerInput').value = ''; renderList();
        }
        function delFish(i) { players.splice(i, 1); localStorage.setItem('strogo_players', JSON.stringify(players)); renderList(); }

        // --- 2. СТАТИСТИКА + ПОИСК РЫБАКОВ ---
        async function getMatchStats() {
            const url = document.getElementById('matchInput').value.trim();
            if(!url) return;
            const resDiv = document.getElementById('statsResult');
            resDiv.innerHTML = '<div style="text-align:center; color:#888;">Закидываем удочку...</div>';

            try {
                const res = await fetch(API_STATS, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({url}) });
                const data = await res.json();
                
                if(data.error) { resDiv.innerHTML = `<div style="text-align:center; color:var(--red);">${data.error}</div>`; return; }

                currentMatchData = data; // Сохраняем для добавления в достижения

                const isWin = data.result === 'WIN';
                resDiv.innerHTML = `
                    <div class="stats-card">
                        <div class="match-header">
                            <div class="match-result ${isWin ? 'win' : 'lose'}">${isWin ? 'VICTORY' : 'DEFEAT'}</div>
                            <div>${data.score}</div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-box"><span class="stat-val">${data.kills}</span><span class="stat-label">Kills</span></div>
                            <div class="stat-box"><span class="stat-val">${data.kd}</span><span class="stat-label">K/D</span></div>
                            <div class="stat-box"><span class="stat-val">${data.hs_percent}%</span><span class="stat-label">HS</span></div>
                        </div>
                        <button class="save-btn" onclick="saveAchievement()">Добавить в достижения</button>
                    </div>
                `;
            } catch(e) { resDiv.innerHTML = 'Ошибка'; }
        }

        // --- 3. ДОСТИЖЕНИЯ ---
        function saveAchievement() {
            if (!currentMatchData) return;

            // 1. Ищем совпадения: Игроки в матче <-> Мой список мониторинга
            let foundNotes = [];
            let myTeamIdx = currentMatchData.my_team_index;
            let matchRoster = currentMatchData.roster; // Массив всех игроков матча

            matchRoster.forEach(matchPlayer => {
                // Ищем этого игрока в нашем списке players
                let isTracked = players.some(p => p.name.toLowerCase() === matchPlayer.nickname.toLowerCase());
                
                if (isTracked) {
                    let relation = (matchPlayer.team_index === myTeamIdx) ? "с " : "vs ";
                    foundNotes.push(`${relation}${matchPlayer.nickname}`);
                }
            });

            // 2. Формируем заголовок
            let title = "Обычный матч";
            if (foundNotes.length > 0) {
                title = foundNotes.join(", ");
            }

            // 3. Сохраняем
            achievements.unshift({
                title: title,
                result: currentMatchData.result,
                score: currentMatchData.score,
                stats: `${currentMatchData.kills} Kills / ${currentMatchData.kd} KD`,
                date: new Date().toLocaleDateString()
            });
            localStorage.setItem('strogo_achievements', JSON.stringify(achievements));
            
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            alert(`Добавлено: ${title}`);
        }

        function renderAchievements() {
            const list = document.getElementById('achievementsList');
            list.innerHTML = '';
            
            if (achievements.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#666; margin-top:20px;">Пока нет трофеев...</div>';
                return;
            }

            achievements.forEach((ach, i) => {
                const el = document.createElement('div');
                el.className = 'ach-card';
                const resColor = ach.result === 'WIN' ? 'var(--green)' : 'var(--red)';
                
                el.innerHTML = `
                    <div class="ach-title">${ach.title}</div>
                    <div class="ach-meta">
                        <span class="ach-res" style="color:${resColor}">${ach.result} (${ach.score})</span>
                        <span>${ach.stats}</span>
                    </div>
                    <div style="position:absolute; right:10px; top:10px; color:#444; cursor:pointer;" onclick="delAch(${i})">×</div>
                `;
                list.appendChild(el);
            });
        }

        function delAch(i) {
            if(confirm('Удалить?')) {
                achievements.splice(i, 1);
                localStorage.setItem('strogo_achievements', JSON.stringify(achievements));
                renderAchievements();
            }
        }

        renderList();
    </script>
</body>
</html>