<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Strogo Fishing</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&family=Montserrat:ital,wght@1,900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #0b0e14;
            --card-bg: rgba(23, 28, 38, 0.95);
            --accent: #ff5500;
            --text-main: #ffffff;
            --text-muted: #8b9bb4;
            --green: #00ff9d;
            --red: #ff4757;
            --glow: 0 0 25px rgba(255, 85, 0, 0.3);
        }

        body {
            background-color: var(--bg);
            background-image: radial-gradient(circle at 20% 50%, #151a25 0%, #0b0e14 80%);
            color: var(--text-main);
            font-family: 'Manrope', sans-serif;
            margin: 0; padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
            display: flex; flex-direction: column;
            position: relative;
        }

        /* ЛЕСКА */
        .fishing-line { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .fishing-line path { fill: none; stroke: var(--accent); stroke-width: 2; stroke-dasharray: 10; opacity: 0.6; filter: drop-shadow(0 0 5px var(--accent)); }

        /* ОБЕРТКА */
        .main-wrapper { position: relative; z-index: 5; width: 100%; max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; }
        
        /* КАРТИНКА (БОЛЬШАЯ) */
        .image-side { position: relative; width: 100%; display: flex; justify-content: flex-start; margin-bottom: 10px; }
        .fisherman-img {
            width: 70vw; /* Крупно на мобиле */
            max-width: 350px; 
            height: auto; 
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.5));
            transform: scaleX(-1); /* Разворот вправо */
            -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
        }

        /* КОНТЕНТ */
        .content-side { width: 100%; max-width: 450px; margin-top: 10px; padding-bottom: 80px; align-self: flex-end; }

        h1 { font-family: 'Montserrat', sans-serif; font-weight: 900; font-style: italic; font-size: 36px; margin: 0 0 25px 0; text-align: right; line-height: 0.9; text-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        h1 span { color: var(--accent); display: block; font-size: 20px; font-weight: 700; font-style: normal; font-family: 'Manrope', sans-serif; margin-top: 5px; text-transform: uppercase; letter-spacing: 4px; }

        /* ТАБЫ */
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; background: rgba(255,255,255,0.03); padding: 5px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .tab-btn { flex: 1; padding: 14px; border: none; background: transparent; color: var(--text-muted); font-family: 'Manrope'; font-weight: 800; font-size: 13px; border-radius: 12px; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        .tab-btn.active { background: rgba(255,255,255,0.1); color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.3); text-shadow: 0 0 10px rgba(255,255,255,0.3); }

        /* СЕКЦИИ */
        .section { display: none; animation: slideUp 0.4s ease; }
        .section.active { display: block; }

        /* ВВОД */
        .controls { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .input-group { position: relative; display: flex; align-items: center; }
        input { width: 100%; padding: 20px; padding-right: 65px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.08); background: rgba(11, 14, 20, 0.85); color: white; font-size: 16px; font-family: inherit; outline: none; transition: 0.3s; backdrop-filter: blur(12px); box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        input:focus { border-color: var(--accent); box-shadow: var(--glow); }
        
        .add-btn { position: absolute; right: 8px; background: var(--accent); color: white; border: none; width: 50px; height: 50px; border-radius: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; box-shadow: 0 0 15px rgba(255, 85, 0, 0.4); z-index: 10; font-size: 24px; }
        .add-btn:active { transform: scale(0.9); }

        /* ФИЛЬТР (СЛАЙДЕР) */
        .filter-toggle { display: flex; align-items: center; gap: 15px; cursor: pointer; width: fit-content; margin-top: 5px; }
        .switch { position: relative; display: inline-block; width: 52px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.1); transition: .4s; border-radius: 34px; border: 1px solid rgba(255,255,255,0.05); }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 2px; background-color: #fff; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--green); border-color: var(--green); }
        input:checked + .slider:before { transform: translateX(24px); background-color: #000; }
        .filter-label { font-size: 13px; font-weight: 700; color: var(--text-muted); transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        input:checked ~ .filter-label { color: var(--green); text-shadow: 0 0 15px rgba(0,255,157,0.5); }

        /* СПИСОК КАРТОЧЕК */
        .fish-list { display: flex; flex-direction: column; gap: 15px; }
        .fish-card { background: var(--card-bg); padding: 20px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); transition: all 0.3s ease; }
        .fish-card.online { border-color: rgba(0, 255, 157, 0.5); background: linear-gradient(90deg, rgba(0, 255, 157, 0.08) 0%, var(--card-bg) 100%); box-shadow: 0 10px 30px rgba(0, 255, 157, 0.05); }
        .fish-info { display: flex; flex-direction: column; gap: 4px; }
        .fish-name { font-weight: 800; font-size: 18px; letter-spacing: 0.5px; }
        .fish-link { font-size: 13px; color: var(--text-muted); text-decoration: none; transition: 0.2s; }
        .status-badge { padding: 8px 14px; border-radius: 12px; font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; background: rgba(255,255,255,0.05); color: var(--text-muted); min-width: 80px; text-align: center; }
        .fish-card.online .status-badge { background: var(--green); color: #0b0e14; box-shadow: 0 0 15px rgba(0,255,157,0.5); }
        .delete-btn { margin-left: 10px; background: none; border: none; color: #444; font-size: 24px; cursor: pointer; padding: 5px; }

        /* СТАТИСТИКА */
        .stats-card { background: var(--card-bg); border-radius: 24px; padding: 30px 20px; border: 1px solid rgba(255,255,255,0.05); text-align: center; margin-top: 20px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.4); }
        .match-header { margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .match-result { font-family: 'Montserrat'; font-weight: 900; font-size: 36px; letter-spacing: 3px; margin-bottom: 8px; text-transform: uppercase; }
        .win { color: var(--green); text-shadow: 0 0 30px rgba(0,255,157,0.4); }
        .lose { color: var(--red); text-shadow: 0 0 30px rgba(255,71,87,0.4); }
        .match-context { font-size: 14px; color: #fff; font-weight: 700; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .match-context span { color: var(--accent); }
        .match-score { font-size: 24px; font-weight: 800; color: white; opacity: 0.9; font-family: 'Montserrat'; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 20px 0; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.02); }
        .stat-val { font-size: 22px; font-weight: 800; color: white; display: block; margin-bottom: 5px; }
        .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }
        .big-stat { grid-column: span 3; display: flex; justify-content: space-around; background: rgba(255, 85, 0, 0.08); border: 1px solid rgba(255, 85, 0, 0.2); }

        /* ДОСТИЖЕНИЯ */
        .save-btn { width: 100%; background: linear-gradient(45deg, #FFD700, #FFAA00); color: #000; border: none; padding: 16px; border-radius: 16px; font-weight: 900; font-size: 14px; margin-top: 20px; cursor: pointer; text-transform: uppercase; letter-spacing: 1.5px; box-shadow: 0 10px 25px rgba(255, 215, 0, 0.25); transition: 0.2s; }
        .save-btn:active { transform: scale(0.98); }
        
        .ach-card { background: linear-gradient(145deg, #161b24, #0f1216); border: 1px solid rgba(255,255,255,0.05); padding: 20px; border-radius: 18px; margin-bottom: 12px; position: relative; overflow: hidden; animation: slideUp 0.3s; }
        .ach-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: #FFD700; box-shadow: 2px 0 15px rgba(255, 215, 0, 0.3); }
        .ach-title { font-weight: 800; font-size: 16px; margin-bottom: 8px; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; }
        .ach-meta { font-size: 13px; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; }
        .ach-res { font-weight: 800; text-transform: uppercase; }
        .ach-link { color: var(--accent); text-decoration: none; font-weight: 700; font-size: 12px; border-bottom: 1px dashed var(--accent); margin-left: 10px; }

        @media (min-width: 900px) {
            body { justify-content: center; padding: 0; }
            .main-wrapper { width: 100%; display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 60px; }
            .image-side { width: 45%; justify-content: flex-end; position: fixed; left: 5%; bottom: 0; }
            .fisherman-img { width: 100%; max-width: 550px; }
            .content-side { width: 45%; margin-top: 0; margin-left: 45%; }
            h1 { text-align: left; font-size: 56px; }
            h1 span { font-size: 28px; }
        }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loader { width: 12px; height: 12px; border: 2px solid #555; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rot 1s infinite linear; }
        @keyframes rot { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <svg id="svg-container" class="fishing-line"><path id="fishingLinePath" d="" /></svg>

    <div class="main-wrapper">
        <div class="image-side">
            <img src="image.png" class="fisherman-img" id="fisherImg" alt="Fisherman">
        </div>

        <div class="content-side">
            <h1>STROGO<span>Рыбалка</span></h1>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('monitor')">Онлайн</button>
                <button class="tab-btn" onclick="switchTab('stats')">Матч</button>
                <button class="tab-btn" onclick="switchTab('achievements')">Достижения</button>
            </div>

            <!-- 1. МОНИТОРИНГ -->
            <div id="monitor-section" class="section active">
                <div class="controls">
                    <div class="input-group">
                        <input type="text" id="playerInput" placeholder="Никнейм или ссылка...">
                        <button class="add-btn" id="btn1" onclick="addNewFish()">+</button>
                    </div>
                    <!-- ФИЛЬТР -->
                    <label class="filter-toggle">
                        <div class="switch">
                            <input type="checkbox" id="filterCheckbox" onchange="toggleFilter()">
                            <span class="slider"></span>
                        </div>
                        <span class="filter-label">Только в пруду</span>
                    </label>
                </div>
                <div id="fishContainer" class="fish-list"></div>
            </div>

            <!-- 2. СТАТИСТИКА -->
            <div id="stats-section" class="section">
                <div class="controls">
                    <div class="input-group">
                        <input type="text" id="matchInput" placeholder="Ссылка на матч...">
                        <button class="add-btn" id="btn2" onclick="getMatchStats()">➜</button>
                    </div>
                </div>
                <div id="statsResult"></div>
            </div>

            <!-- 3. ДОСТИЖЕНИЯ -->
            <div id="achievements-section" class="section">
                <div id="achievementsList" class="fish-list"></div>
            </div>

        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); tg.headerColor = '#0b0e14'; tg.backgroundColor = '#0b0e14';

        const API_CHECK = "/api/check_fish"; 
        const API_STATS = "/api/get_match_stats";

        // ДАННЫЕ
        let currentMatchData = null; 
        let currentMatchUrl = "";
        let currentMatchContext = ""; // Хранит строку "vs X, c Y"

        let players = [{ name: "m0NESY", url: "https://www.faceit.com/ru/players/m0NESY" }, { name: "donk666", url: "https://www.faceit.com/ru/players/donk666" }];
        let achievements = [];

        if (localStorage.getItem('strogo_players')) players = JSON.parse(localStorage.getItem('strogo_players'));
        if (localStorage.getItem('strogo_achievements')) achievements = JSON.parse(localStorage.getItem('strogo_achievements'));

        // --- ЛЕСКА ---
        function updateLine() {
            const path = document.getElementById('fishingLinePath');
            const img = document.getElementById('fisherImg');
            const activeSec = document.querySelector('.section.active');
            let btn = activeSec.id === 'monitor-section' ? document.getElementById('btn1') : document.getElementById('btn2');
            if (activeSec.id === 'achievements-section') btn = null;

            if (!img || !btn) { path.setAttribute('d', ''); return; }
            
            const isDesktop = window.innerWidth > 900;
            const r1 = img.getBoundingClientRect();
            const r2 = btn.getBoundingClientRect();
            
            // Точки привязки лески
            const sx = r1.left + r1.width * (isDesktop ? 0.8 : 0.7); 
            const sy = r1.top + r1.height * 0.3;
            const ex = r2.left + r2.width/2; 
            const ey = r2.top + r2.height/2;
            
            path.setAttribute('d', `M ${sx} ${sy} Q ${(sx+ex)/2} ${Math.max(sy,ey)+100} ${ex} ${ey}`);
        }
        setInterval(updateLine, 200);

        // --- ТАБЫ ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            const btn = document.querySelector(`button[onclick="switchTab('${tab}')"]`);
            if(btn) btn.classList.add('active');
            
            document.getElementById(tab + '-section').classList.add('active');
            
            if(tab === 'achievements') renderAchievements();
            setTimeout(updateLine, 50);
        }

        // --- 1. ОНЛАЙН + ФИЛЬТР ---
        function renderList() {
            const c = document.getElementById('fishContainer'); c.innerHTML = '';
            const isFilterOn = document.getElementById('filterCheckbox').checked;

            if(players.length === 0) c.innerHTML = '<div style="text-align:center; color:#444;">Пусто...</div>';

            players.forEach((p, i) => {
                const div = document.createElement('div'); 
                div.className = 'fish-card';
                div.id = `card-${i}`;
                // Храним статус для фильтра
                div.dataset.status = 'loading'; 

                div.innerHTML = `
                    <div class="fish-info">
                        <span class="fish-name">${p.name}</span>
                        <a href="${p.url}" class="fish-link" target="_blank">Профиль</a>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <div class="status-badge" id="s-${i}"><span class="loader"></span></div>
                        <div class="delete-btn" onclick="delFish(${i})">×</div>
                    </div>`;
                c.appendChild(div); 
                checkStatus(p.url, i);
            });
            applyFilter();
        }

        async function checkStatus(url, i) {
            const card = document.getElementById(`card-${i}`);
            const badge = document.getElementById(`s-${i}`);
            if(!card) return;

            try {
                const res = await fetch(API_CHECK, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({url}) });
                const d = await res.json();
                
                if(d.status === 'online') { 
                    badge.textContent = 'В ПРУДУ'; 
                    card.classList.add('online'); 
                    card.dataset.status = 'online';
                } else { 
                    badge.textContent = 'OFF'; 
                    card.classList.remove('online');
                    card.dataset.status = 'offline';
                }
            } catch(e) { 
                badge.textContent = 'ERR'; 
                card.dataset.status = 'error';
            }
            applyFilter(); // Обновляем фильтр после получения статуса
        }

        function toggleFilter() { applyFilter(); }

        function applyFilter() {
            const isFilterOn = document.getElementById('filterCheckbox').checked;
            document.querySelectorAll('.fish-card').forEach(card => {
                const st = card.dataset.status;
                // Показываем если фильтр выключен ИЛИ если статус 'online'/'loading'
                if (!isFilterOn || st === 'online' || st === 'loading') {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function addNewFish() {
            const v = document.getElementById('playerInput').value.trim();
            if(!v) return;
            let name = v.includes('faceit.com') ? v.split('/').pop() : v;
            let url = v.includes('faceit.com') ? v : `https://www.faceit.com/ru/players/${v}`;
            players.unshift({name, url}); 
            localStorage.setItem('strogo_players', JSON.stringify(players));
            document.getElementById('playerInput').value = ''; 
            renderList();
        }
        function delFish(i) { players.splice(i, 1); localStorage.setItem('strogo_players', JSON.stringify(players)); renderList(); }

        // --- 2. СТАТИСТИКА + КОНТЕКСТ ---
        function getContext(matchData) {
            if (!matchData.roster) return "";
            
            let notes = [];
            let myTeamIdx = matchData.my_team_index;
            
            matchData.roster.forEach(mp => {
                // Ищем совпадение в списке players
                let isTracked = players.some(p => p.name.toLowerCase() === mp.nickname.toLowerCase());
                
                if (isTracked) {
                    // Если это сам StRoGo, пропускаем (чтобы не писать "с StRoGo")
                    if (mp.nickname.toLowerCase() === "strogo") return;

                    let relation = (mp.team_index === myTeamIdx) ? "с " : "vs ";
                    notes.push(`${relation}${mp.nickname}`);
                }
            });
            
            return notes.length > 0 ? notes.join(", ") : "";
        }

        async function getMatchStats() {
            const url = document.getElementById('matchInput').value.trim();
            if(!url) return;
            currentMatchUrl = url; // Запоминаем ссылку

            const resDiv = document.getElementById('statsResult');
            resDiv.innerHTML = '<div style="text-align:center; color:#888; font-weight:700;">Поклевка...</div>';

            try {
                const res = await fetch(API_STATS, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({url}) });
                const data = await res.json();
                
                if(data.error) { 
                    resDiv.innerHTML = `<div style="text-align:center; color:var(--red); font-weight:800;">${data.error}</div>`; 
                    return; 
                }

                currentMatchData = data;
                currentMatchContext = getContext(data); // Вычисляем контекст

                const isWin = data.result === 'WIN';
                
                // HTML для контекста (vs X / c Y)
                let contextHtml = currentMatchContext ? `<div class="match-context">${currentMatchContext}</div>` : '';

                resDiv.innerHTML = `
                    <div class="stats-card">
                        <div class="match-header">
                            <div class="match-result ${isWin ? 'win' : 'lose'}">${isWin ? 'VICTORY' : 'DEFEAT'}</div>
                            ${contextHtml}
                            <div class="match-score">${data.nickname} (${data.score})</div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-box"><span class="stat-val">${data.kills}</span><span class="stat-label">Kills</span></div>
                            <div class="stat-box"><span class="stat-val">${data.deaths}</span><span class="stat-label">Deaths</span></div>
                            <div class="stat-box"><span class="stat-val">${data.assists}</span><span class="stat-label">Assists</span></div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-box big-stat">
                                <div><span class="stat-val">${data.kd}</span><span class="stat-label">K/D</span></div>
                                <div><span class="stat-val">${data.hs_percent}%</span><span class="stat-label">HS</span></div>
                                <div><span class="stat-val">${data.kr}</span><span class="stat-label">K/R</span></div>
                            </div>
                        </div>
                        <div style="font-size:12px; color:#555; margin-top:10px;">MVP: ${data.mvp}</div>
                        <button class="save-btn" onclick="saveAchievement()">Сохранить трофей</button>
                    </div>
                `;
            } catch(e) { resDiv.innerHTML = 'Ошибка'; }
        }

        // --- 3. ДОСТИЖЕНИЯ ---
        function saveAchievement() {
            if (!currentMatchData) return;

            let title = currentMatchContext || "Обычный матч";

            achievements.unshift({
                title: title,
                result: currentMatchData.result,
                score: currentMatchData.score,
                stats: `${currentMatchData.kills} K / ${currentMatchData.kd} KD`,
                url: currentMatchUrl // Сохраняем ссылку!
            });
            localStorage.setItem('strogo_achievements', JSON.stringify(achievements));
            
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            alert(`Сохранено: ${title}`);
        }

        function renderAchievements() {
            const list = document.getElementById('achievementsList');
            list.innerHTML = '';
            
            if (achievements.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#666; margin-top:20px;">Нет трофеев...</div>';
                return;
            }

            achievements.forEach((ach, i) => {
                const el = document.createElement('div');
                el.className = 'ach-card';
                const resColor = ach.result === 'WIN' ? 'var(--green)' : 'var(--red)';
                
                // Добавляем ссылку
                let linkHtml = ach.url ? `<a href="${ach.url}" target="_blank" class="ach-link">МАТЧ ➜</a>` : '';

                el.innerHTML = `
                    <div class="ach-title">${ach.title}</div>
                    <div class="ach-meta">
                        <span class="ach-res" style="color:${resColor}">${ach.result} (${ach.score})</span>
                        <span>${ach.stats} ${linkHtml}</span>
                    </div>
                    <div style="position:absolute; right:10px; top:10px; color:#444; cursor:pointer;" onclick="delAch(${i})">×</div>
                `;
                list.appendChild(el);
            });
        }

        function delAch(i) {
            if(confirm('Удалить?')) {
                achievements.splice(i, 1);
                localStorage.setItem('strogo_achievements', JSON.stringify(achievements));
                renderAchievements();
            }
        }

        renderList();
    </script>
</body>
</html>